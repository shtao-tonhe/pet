# 用户身份认证系统 - 开发规范

## 一、通用约定

### 1.1 接口风格
- RESTful 风格
- 请求方法：`POST`
- 数据格式：`application/json`
- 响应格式：统一 JSON 结构（见下文）

### 1.2 全局响应结构
```json
{
  "code": 200,
  "message": "操作成功",
  "data": { ... } // 成功时有数据，失败时为 null 或省略
}
```

#### 状态码说明（code）
| code | 含义 |
|------|------|
| 200  | 成功 |
| 400  | 请求参数错误（如格式、缺失） |
| 401  | 未授权（如验证码错误、密码错误） |
| 409  | 冲突（如手机号已注册） |
| 500  | 服务器内部错误 |

> 注：HTTP 状态码统一返回 200，业务状态通过 `code` 字段区分。

---

## 二、接口定义

### 2.1 发送短信验证码（通用）

**接口路径**：`/api/v1/auth/send-sms-code`
**请求方法**：`POST`

#### 请求参数
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| phone | string | 是 | 手机号（需符合中国大陆手机号正则：`^1[3-9]\d{9}$`） |
| purpose | string | 是 | 验证码用途，枚举值（见下文） |

#### 枚举：purpose
| 值 | 说明 |
|----|------|
| `REGISTER` | 注册 |
| `LOGIN` | 登录 |
| `RESET_PASSWORD` | 忘记密码 |

#### 响应示例（成功）
```json
{
  "code": 200,
  "message": "验证码已发送"
}
```

#### 业务规则校验
- 若该手机号 60 秒内已发送过相同用途的验证码 → 返回 `400`：“请稍后再试”
- 若用途为 `REGISTER` 且手机号已存在 → 返回 `409`：“该手机号已注册”

---

### 2.2 注册账号

**接口路径**：`/api/v1/auth/register`
**请求方法**：`POST`

#### 请求参数
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| phone | string | 是 | 手机号 |
| smsCode | string | 是 | 短信验证码（6位数字） |
| password | string | 是 | 密码（6-20位，必须包含字母+数字） |

#### 响应示例（成功）
```json
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "userId": "u_1234567890",
    "phone": "138****1234"
  }
}
```

#### 校验规则
- 手机号格式合法
- 验证码存在且未过期（5分钟）、且与手机号匹配
- 密码强度：长度6-20，至少包含1个字母 + 1个数字（不区分大小写）
- 手机号未注册（唯一性）

---

### 2.3 登录（密码方式）

**接口路径**：`/api/v1/auth/login/password`
**请求方法**：`POST`

#### 请求参数
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| phone | string | 是 | 手机号 |
| password | string | 是 | 密码 |

#### 响应示例（成功）
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.xxxxx",
    "expiresIn": 604800, // 7天，单位秒
    "userId": "u_1234567890",
    "phone": "138****1234"
  }
}
```

#### 校验规则
- 账号存在
- 密码正确（BCrypt 加密比对）

---

### 2.4 登录（短信验证码方式）

**接口路径**：`/api/v1/auth/login/sms`
**请求方法**：`POST`

#### 请求参数
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| phone | string | 是 | 手机号 |
| smsCode | string | 是 | 短信验证码 |

#### 响应结构
同 **2.3 登录（密码方式）**

#### 校验规则
- 验证码有效（5分钟内、匹配手机号、用途为 `LOGIN`）

---

### 2.5 忘记密码 - 重置密码

**接口路径**：`/api/v1/auth/password/reset`
**请求方法**：`POST`

#### 请求参数
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| phone | string | 是 | 手机号 |
| smsCode | string | 是 | 验证码（用途为 `RESET_PASSWORD`） |
| newPassword | string | 是 | 新密码（需满足密码强度规则） |

#### 响应示例（成功）
```json
{
  "code": 200,
  "message": "密码重置成功"
}
```

#### 校验规则
- 账号存在
- 验证码有效
- 新密码符合强度要求（6-20位，字母+数字组合）

---

### 2.6 退出登录

**接口路径**：`/api/v1/auth/logout`
**请求方法**：`POST`
**Header**：需携带 `Authorization: Bearer <token>`

#### 请求参数
无

#### 响应
```json
{
  "code": 200,
  "message": "已退出登录"
}
```

> 实现：将 token 加入短期黑名单（或直接清除客户端 token）

---

### 2.7 注销账号（谨慎操作）

**接口路径**：`/api/v1/auth/account/delete`
**请求方法**：`POST`
**Header**：需携带有效 token

#### 请求参数
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| confirmDelete | boolean | 是 | 必须为 `true`，防止误触 |

#### 响应
```json
{
  "code": 200,
  "message": "账号已注销"
}
```

> 实现建议：
> - 软删除（标记 `is_deleted = true`）
> - 清除敏感信息（如密码哈希保留，手机号脱敏）
> - 使所有 token 失效
